# Phase 3: RAG 问答 - AI 助手设计文档

> **Status:** 设计完成，等待实施
> **Date:** 2026-01-20

---

## 一、产品目标

**核心价值**: 实现"与数据对话"，用户可以用自然语言提问，从已收藏的内容中找到答案。

**用户场景**:
- "我的保险免赔额是多少？" → 返回相关文档中的免赔额条款
- "帮我总结这个 PDF 的要点" → 提取 PDF 主要内容
- "去年 3 月的会议记录在哪里？" → 语义搜索相关文档

---

## 二、整体架构

```
用户提问
    ↓
┌─────────────────────────────┐
│  AIAssistant (侧边栏面板)    │
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│  对话管理器 (10轮上下文)     │
│  - ChatHistory[]            │
│  - maxRounds = 10           │
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│  混合检索引擎                │
│  - 向量搜索 (LanceDB)       │
│  - 关键词搜索 (FTS5/BM25)   │
│  - 结果合并、去重            │
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│  Prompt 构建器               │
│  - 系统提示词                │
│  - 检索到的 Context          │
│  - 对话历史                  │
└──────────────┬──────────────┘
               ↓
┌─────────────────────────────┐
│  LLM Provider (云端)         │
│  - 流式输出                  │
│  - Token 配额检查            │
└──────────────┬──────────────┘
               ↓
返回答案 + 来源标注 [1] [2]
```

---

## 三、轻量级混合检索引擎

### 3.1 检索流程

```
         User Query
              │
              ▼
    ┌─────────────────────┐
    │  Query Pre-processing│
    └──────────┬──────────┘
               │
    ┌──────────┴──────────┐
    ▼                     ▼
┌────────┐          ┌────────┐
|BM25    │          | Vector │
│(FTS5)  │          │Search  │
└───┬────┘          └───┬────┘
    │                   │
    └─────────┬─────────┘
              │
              ▼
    ┌─────────────────────┐
    │  Simple Fusion      │
    │  - Score weighted   │
    │  - Deduplication    │
    │  - Top 5            │
    └─────────────────────┘
```

### 3.2 融合策略

| 维度 | 权重 | 说明 |
|------|------|------|
| 向量相似度 | 0.6 | 语义匹配优先 |
| BM25 得分 | 0.4 | 关键词精确匹配 |
| Top-K | 5 | 限制返回数量 |
| 去重 | - | 相同 ID 去重 |

---

## 四、对话管理器

### 4.1 上下文管理

- **最大轮数**: 10 轮（可配置）
- **截断策略**: 超出后移除最早的轮次
- **内容**: 保留 `role` + `content` + `sources`

### 4.2 对话历史结构

```typescript
interface ChatMessage {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: SearchResult[];  // 仅 assistant 有
  timestamp: number;
}

interface ChatSession {
  id: string;
  messages: ChatMessage[];
  createdAt: number;
}
```

---

## 五、数据流

### 5.1 完整流程

```
1. 用户输入问题
   ↓
2. 对话历史组装 (最近 10 轮)
   ↓
3. 混合检索 (并行 BM25 + Vector)
   ↓
4. 结果融合 (Top 5)
   ↓
5. 构建 Prompt
   - System: 角色设定
   - Context: 检索内容 + 来源标注
   - History: 对话历史
   - User: 当前问题
   ↓
6. Token 配额检查
   - Free: 10K tokens/月
   - Pro: 1M tokens/月
   ↓
7. 调用 LLM (流式)
   ↓
8. 返回结果 (内容 + 来源 + Token 消耗)
```

### 5.2 Prompt 模板

```typescript
const SYSTEM_PROMPT = `你是 OmniClipper 知识助手。

## 规则
1. 基于提供的资料回答问题，不要编造信息
2. 如果资料不足以回答，明确说明
3. 用中文回答，除非用户用英文提问
4. 回答要简洁，条理清晰

## 格式
- 使用编号列表呈现多个要点
- 重要信息加粗强调
- 引用来源使用 [编号] 标注`;

const USER_PROMPT = `## 资料
${context}

## 对话历史
${chatHistory}

## 问题
${question}`;
```

---

## 六、错误处理

| 场景 | 处理方式 | 用户提示 |
|------|---------|---------|
| **向量库未初始化** | 返回友好提示 | "AI 助手正在准备中，请稍候..." |
| **检索无结果** | 返回空来源 | "未找到相关内容，建议换个问题" |
| **LLM API 失败** | 重试 1 次 | "网络问题，请重试" |
| **Token 配额不足** | 阻止请求 | "本月配额已用完，升级 Pro 解锁无限 AI" |
| **用户未登录** | 提示登录 | "登录后可使用完整 AI 功能" |

---

## 七、UI 设计

### 7.1 组件结构

```
AIAssistant.tsx (主组件)
├── AIAssistantHeader
│   ├── 标题: "AI 助手"
│   └── 清空对话按钮
├── ChatMessages
│   ├── MessageItem
│   │   ├── UserMessage
│   │   └── AssistantMessage
│   │       └── SourceCitations
│   └── LoadingIndicator
├── ChatInput
│   ├── Textarea
│   ├── Send 按钮
│   └── Token 配额显示
└── QuickActions
```

### 7.2 布局

```
┌─────────────────────────────┐
│ AI 助手              ✕      │ ← Header
├─────────────────────────────┤
│                             │
│  你好！有什么可以帮你？       │ ← AI 消息
│  📚 已索引 128 条内容        │
│                             │
│ ─────────────────────────── │
│                             │
│  我的保险免赔额是多少？       │ ← 用户消息
│                             │
│ ─────────────────────────── │
│                             │
│  根据资料，免赔额分为... [1][2]│ ← AI 消息
│  • 绝对免赔额: xxx           │
│  • 相对免赔额: xxx           │
│                             │
│  ┌─────────────────────┐    │
│  │ 来源:               │    │
│  │ [1] 保险条款.pdf 85%│    │ ← 来源卡片
│  │ [2] 车险说明.md 72% │    │
│  └─────────────────────┘    │
│                             │
├─────────────────────────────┤
│ 你想了解什么？         ↗     │ ← 输入框
│                             │
└─────────────────────────────┘
```

### 7.3 交互规范

| 交互 | 行为 |
|------|------|
| **发送消息** | Enter 发送，Shift+Enter 换行 |
| **流式输出** | 打字机效果逐字显示 |
| **来源点击** | 点击 [1] 跳转到对应资源 |
| **清空对话** | 弹出确认对话框 |
| **配额不足** | 输入框禁用，显示升级提示 |

---

## 八、文件清单

### 新建文件

| 路径 | 用途 |
|------|------|
| `components/AIAssistant.tsx` | AI 对话主组件 |
| `services/chatService.ts` | 对话管理服务 |
| `services/hybridSearchService.ts` | 混合检索服务 |
| `types/chat.ts` | 对话相关类型定义 |

### 修改文件

| 路径 | 改动 |
|------|------|
| `components/Sidebar.tsx` | 添加 AI 助手入口按钮 |
| `App.tsx` | 集成 AIAssistant |
| `services/llmProvider.ts` | 流式输出支持 |

---

## 九、后续优化

| 优化项 | 说明 |
|--------|------|
| Query Expansion | 使用小模型生成查询变体 |
| LLM Reranking | 使用 reranker 模型精排 |
| 高级 Fusion | RRF + Position-Aware Blend |

---

*文档版本: v1.0*
*最后更新: 2026-01-20*
