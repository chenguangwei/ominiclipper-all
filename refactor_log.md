# Ominiclipper Refactoring Log
Created: 2026-01-22

## 2026-01-22 17:00 - Directory Structure Standardization
- **Action**: Created `src` directory structure for both `ominiclipper-desktop` and `browser-extension`.
- **Details**: 
  - Standardized project layout to follow modern conventions (`src/components`, `src/services`, `src/utils`).
  - Updated `tsconfig.json` and `vite.config.ts` in both projects to support path aliases (`@/*` -> `./src/*`).

## 2026-01-22 17:30 - Desktop `storageService` Refactor
- **Action**: Decomposed monolithic `ominiclipper-desktop/src/services/storageService.ts` (>1300 lines).
- **Outcome**: Created modular services in `src/services/storage/`:
  - `types.ts`: Shared interfaces.
  - `state.ts`: Singleton state management.
  - `persistence.ts`: Core data saving/loading logic.
  - `items.ts`, `tags_folders.ts`, `settings.ts`: Domain-specific CRUD operations.
  - **Note**: `storageService.ts` was kept as a facade for backward compatibility.

## 2026-01-22 18:00 - Desktop `App.tsx` Refactor
- **Action**: Refactored `src/app/App.tsx` (>1500 lines).
- **Outcome**: Extracted logic into custom hooks in `src/hooks/`:
  - `useAppInit.ts`: Initialization logic.
  - `useSemanticSearch.ts` & `useFiltering.ts`: Search and filter state.
  - `useSync.ts`: Cloud synchronization.
  - `useDragDrop.ts`: File handling.
  - `useKeyboardShortcuts.ts`: Global shortcuts.
- **Result**: `App.tsx` reduced to UI layout and composition only.

## 2026-01-22 18:30 - Extension `background.js` Refactor
- **Action**: Modularized `browser-extension/src/background/index.ts`.
- **Outcome**: Split functionalities:
  - `handlers/contextMenus.ts`: Menu creation and event handling.
  - `handlers/messages.ts`: Central message dispatcher.
  - `services/capture.ts`: Tab capture logic.
  - `services/syncQueue.ts`: Offline sync management.

## 2026-01-22 19:00 - Extension `content.js` Refactor
- **Action**: Verified and refactored `browser-extension/src/content/index.ts` (~800 lines).
- **Outcome**: Split into functional modules:
  - `extractors/`: Metadata and article extraction logic.
  - `ui/`: Selection overlay components.
  - `capture/`: Screenshot capture utilities.
  - `services/`: AI summarization integration.

## 2026-01-22 19:15 - Desktop Build Fix & Electron Migration
- **Issue**: `npm run electron:dev` failed due to missing `preload.cjs`.
- **Action**:
  1. Updated `ominiclipper-desktop/vite.config.ts` to use `vite-plugin-electron`.
  2. Migrated `electron/main.cjs` to TypeScript at `electron/main/index.ts`.
  3. Ensured `preload.ts` compiles to `preload.cjs` correctly.
  4. Fixed `require` vs `import` compatibility issues in Vite config.
- **Status**: Build verified successfully for both Desktop and Extension.

## 2026-01-22 21:30 - Desktop Post-Refactor Cleanup (Build Fixes)
- **Issue**: `npm run dev` failed with `SyntaxError: Unexpected token 'export'` in Electron main process, and valid build failed due to missing exports in `storageService.ts` facade.
- **Action**:
  1. Updated `vite.config.ts` to use `build.lib` mode for Electron main process.
  2. Implemented a custom `removeExportDefaultPlugin` in `vite.config.ts` to strip invalid `export default` statements from `preload.cjs` (which were automatically generated by Vite but incompatible with Electron).
  2. Implemented missing methods in `src/services/storage/items.ts` (`exportData`, `importData`) and `src/services/storage/settings.ts` (`getRecentFiles`, `setRecentFiles`, etc).
  3. Cleaned up duplicate function definitions in `src/services/storage/tags_folders.ts`.
  4. Resolved `ResourceItem` type mismatches in vector indexing logic.
  5. Verified successful build (`npm run build`) and dev mode start.
- **Issue**: Runtime error `TypeError: onSelect is not a function` in `ListDetailView`, and missing Preview pane.
- **Action**: Updated `App.tsx` to correct `ListDetailView` props (`selectedId`, `onSelect`, `getTagName`) and restored the 2-pane layout with `PreviewPane`.
- **Issue**: "File reference has expired" error after dragging files.
- **Action**: Updated `src/hooks/useDragDrop.ts` to prevent usage of Blob URLs for persistent storage. Added fallback to Base64 embedding if file path is missing, and ensured files are copied to storage library when path is available.
- **Issue**: Preview not available for PPT and Excel files; `SyntaxError: Unexpected token 'export'` in `main.cjs`.
- **Action**:
  1. Updated `fileHelpers.ts` to correctly detect `ppt/pptx` and `xls/xlsx` types.
  2. Updated `ResourcePreview.tsx` to add UI support for PPT and Excel (providing "Open in App" buttons).
  3. Applied `removeExportDefaultPlugin` to Main process config in `vite.config.ts`, fixing the CJS export error.
  4. Fixed syntax error in `ResourcePreview.tsx`.
